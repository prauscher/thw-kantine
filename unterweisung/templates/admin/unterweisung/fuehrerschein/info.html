{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrastyle %}{{ block.super }}<link rel="stylesheet" href="{% static "admin/css/forms.css" %}">{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label="unterweisung" %}">Unterweisung</a>
&rsaquo; <a href="{% url 'admin:unterweisung_fuehrerschein_changelist' %}">Führerscheindaten</a>
&rsaquo; Übersicht
</div>
{% endblock %}

{% block content %}
<h2>Abgleich</h2>

<p>Der Abgleich zeigt automatisch Abweichungen zwischen THWin-Stand und hinterlegten Führerscheinen
 an. Hierfür muss ein Export aus THWin unter <code>Auswertungen & Abfragen</code> &raquo;
 <code>Helferverwaltung</code> &raquo; <code>Qualifikationen</code> &raquo;
 <code>Ausbildung / Berechtigungen / Gesundheitsvorsorgen</code> für die Qualifikationsart
 <code>Berechtigungen</code> angezeigt, unter <code>Drucken</code> als <code>Listenausdruck</code>
 mittels <code>CSV</code> abgespeichert und hier hochgeladen werden. Der Export kann dabei auf
 die Qualifikationen <code>KFZ-Fahrerlaubnis ...</code> eingeschränkt werden.</p>

{% if error %}
<p class="errornote">{{ error }}</p>
{% endif %}

<form method="post" enctype="multipart/form-data">
 {% csrf_token %}
 <fieldset class="module aligned">
  <div class="form-row">
   <div>
   <div class="flex-container">
    <label for="thwin_export">THWin-Export:</label>
    <input type="file" name="thwin_export" id="thwin_export" />
   </div>
   </div>
  </div>
 </fieldset>
 <div class="submit-row">
  <input type="submit" value="Abgleichen" class="default" name="_check">
 </div>
</form>

<h2>Übersicht</h2>

<p>Nachfolgend werden alle hinterlegten Führerscheine mit Nummer den Gültigkeitsdaten der Fahrerlaubnisse angezeigt.
 {% if abgleich %}Fehler im hochgeladenen THWin-Export werden hier <strong style="color:red;">rot</strong> markiert.{% endif %}</p>

<table>
<thead style="position:sticky; top:0;">
<tr>
 <th scope="col">Teilnehmer*in</th>
 <th scope="col">Nummer</th>
 {% for klasse in klassen %}
 <th scope="col">{{ klasse }}</th>
 {% endfor %}
</tr>
</thead>
<tbody>
{% for teilnehmer, nummer, nummer_error, fahrerlaubnisse in fuehrerscheine %}
<tr>
 <th scope="row">{{ teilnehmer }}</th>
 <td>{% if nummer_error %}<strong style="color:red;">{{ nummer }}</strong>{% else %}{{ nummer }}{% endif %}</td>
 {% for gueltig_ab, gueltig_ab_error, gueltig_bis, gueltig_bis_error in fahrerlaubnisse %}
 <td>
  {% if gueltig_ab %}
  {% if gueltig_ab_error %}<strong style="color:red;">{% endif %}{{ gueltig_ab|date:"d.m.Y" }}{% if gueltig_ab_error %}</strong>{% endif %}<br />
  {% if gueltig_bis_error %}<strong style="color:red;">{% endif %}{% if gueltig_bis %}{{ gueltig_bis|date:"d.m.Y" }}{% else %}-{% endif %}{% if gueltig_bis_error %}</strong>{% endif %}
  {% endif %}
 </td>
 {% endfor %}
</tr>
{% endfor %}
</tbody>
</table>
<ul>
{% for gruppe, url in gruppen %}
<li><a href="{{ url }}">{{ gruppe|default:"(Ohne Gruppenzuordnung)" }}</a></li>
{% endfor %}
</ul>
{% endblock %}
