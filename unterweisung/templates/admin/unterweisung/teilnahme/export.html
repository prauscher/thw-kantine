{% extends "abfrage/base.html" %}
{% load mathfilters %}

{% block title %}Unterweisungsübersicht{% endblock %}

{% block content %}
<ul class="nav nav-tabs mb-2">
 <li class="nav-item">
  <a class="nav-link {% if quantiles %}active{% endif %}" href="?include_stats">Statistiken</a>
 </li>
 <li class="nav-item">
  <a class="nav-link {% if "only_open" in request.GET %}active{% endif %}" href="?only_open">Fehlende</a>
 </li>
 <li class="nav-item">
  <a class="nav-link {% if not quantiles and "only_open" not in request.GET %}active{% endif %}" href="?">Ausdruck</a>
 </li>
</ul>

{% if quantiles %}
<div class="progress">
  <div class="progress-bar" role="progressbar" style="width: {% widthratio teilnahmen_done teilnahmen_total 100 %}%" aria-valuenow="{{ teilnahmen_done }}" aria-valuemin="0" aria-valuemax="{{ teilnahmen_total }}"></div>
</div>
<p>Teilnahmen erledigt: <strong>{{ teilnahmen_done }}</strong>, Teilnahmen offen: <strong>{{ teilnahmen_open }}</strong>, Teilnahmen insgesamt: <strong>{{ teilnahmen_total }}</strong>.</p>
{% endif %}

<table class="table table-striped">
<thead>
{% if not quantiles %}
 <tr>
  <td colspan="{{ unterweisungen|length|add:2 }}">
   Mit der Unterschrift bestätige ich, die Unterweisung alleine bearbeitet und vollständig
   verstanden zu haben.
  </td>
 </tr>
{% endif %}
 <tr>
  <th scope="col">Helfer*in</th>
  {% for unterweisung in unterweisungen %}
  <th scope="col">{{ unterweisung.short_label }}</th>
  {% endfor %}
  {% if not quantiles %}
  <th scope="col" style="min-width:10em;">Unterschrift</th>
  {% endif %}
 </tr>
</thead>
{% for gruppe, personen in gruppen %}
{% if personen %}
<tbody>
 <tr>
  {% if quantiles %}
   <th colspan="{{ unterweisungen|length|add:1 }}">{{ gruppe }}</th>
  {% else %}
   <th colspan="{{ unterweisungen|length|add:2 }}">{{ gruppe }}</th>
  {% endif %}
 </tr>
 {% for teilnehmer, data in personen %}
 <tr>
  <th scope="row">
   {% if teilnehmer.fullname %}{{ teilnehmer.fullname }}{% else %}{{ teilnehmer.username }}{% endif %}
  </th>
  {% for teilnahme in data.teilnahmen %}
  <td>
   {% if teilnahme.1 is False %}
    <span class="badge bg-danger">Offen</span>
   {% elif teilnahme.1 is None %}
    <em>-</em>
   {% else %}
    {{ teilnahme.1|linebreaksbr }}
   {% endif %}
   {% if quantiles and teilnahme.2 %}
    <br />
    {% widthratio teilnahme.2 60 1 as duration_minutes %}
    <em>{{ duration_minutes|floatformat:1 }}min</em>
   {% endif %}
  </td>
  {% endfor %}
  {% if not quantiles %}
  <td>&nbsp;</td>
  {% endif %}
 </tr>
 {% endfor %}
</tbody>
{% endif %}
{% endfor %}
{% if quantiles %}
<tfoot>
 <tr>
  <th scope="row">Median-Dauer</th>
  {% for quantile in quantiles %}
  <td>
   {% if quantile is None %}
    <em>-</em>
   {% else %}
    {% widthratio quantile.median 60 1 as median_minutes %}
    {{ median_minutes|floatformat:1 }}min
   {% endif %}
  </td>
  {% endfor %}
 </tr>
</tfoot>
{% endif %}
</table>

<style type="text/css">
@media print {
	h1, nav, .nav {display:none;}
}
</style>
{% endblock %}
