{% extends "abfrage/base.html" %}
{% load crispy_forms_filters %}

{% load crispy_forms_tags %}

{% block content %}
<form method="post">{% csrf_token %}
 <h4>Einstellungen</h4>
 {{ form | crispy }}
 <h4>Gerichte</h4>
 <div id="servings" class="container">
 </div>
 <button type="submit" class="btn-success btn">{% if object %}Bearbeiten{% else %}Anlegen{% endif %}</button>
</form>
{% endblock %}

{% block script %}
{{ icons | json_script:"py_icons" }}
{% if object %}
{{ servings | json_script:"py_servings" }}
{% endif %}
<script type="text/javascript">

function _getStartServings() {
	if (document.getElementById('py_servings')) {
		return JSON.parse(document.getElementById('py_servings').textContent);
	}
	return [];
}

const icons = JSON.parse(document.getElementById('py_icons').textContent);
const start_servings = _getStartServings();

function addServing(serving) {
	if (! serving) {
		serving = {"pk": "new" + $("#servings").find(".row").length, "label": "", "icon": ""};
	}

	$("#servings").append(
		$("<div>").addClass(["row", "mb-3"]).append([
			$("<div>").addClass(["col-4", "col-md-2"]).append(
				$("<select>")
					.addClass("form-select").attr("name", "serving-" + serving.pk + "-icon")
					.append(icons.map((icon) => $("<option>").attr("value", icon[0]).text(icon[1])))
					.val(serving.icon)
			),
			$("<div>").addClass(["col-8", "col-md-10"]).append(
				$("<input>")
					.addClass("form-control").attr("name", "serving-" + serving.pk + "-label")
					.on("keyup", checkServings)
					.val(serving.label)
			)
		])
	);
}

function checkServings() {
	if ($("#servings").length === 0) {
		return;
	}

	if ($("#servings").find(".row input").filter((i, item) => $(item).val() === "").length <= 0) {
		addServing();
	}
}

$(function () {
	for (const serving of start_servings) {
		addServing(serving);
	}
	checkServings();
});

</script>
{% endblock %}
